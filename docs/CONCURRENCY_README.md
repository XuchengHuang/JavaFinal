# å¤šçº¿ç¨‹ä¸å¹¶å‘æ§åˆ¶å®ç°è¯´æ˜

## ğŸ“‹ ç›®å½•

1. [æ¦‚è¿°](#æ¦‚è¿°)
2. [å¤šçº¿ç¨‹è¿æ¥å¤„ç†](#å¤šçº¿ç¨‹è¿æ¥å¤„ç†)
3. [å¹¶å‘æ§åˆ¶æœºåˆ¶](#å¹¶å‘æ§åˆ¶æœºåˆ¶)
4. [å·¥ä½œåŸç†è¯¦è§£](#å·¥ä½œåŸç†è¯¦è§£)
5. [å®é™…åº”ç”¨åœºæ™¯](#å®é™…åº”ç”¨åœºæ™¯)
6. [ä»£ç ç¤ºä¾‹](#ä»£ç ç¤ºä¾‹)

---

## æ¦‚è¿°

ä¸ºäº†è®© AsteriTime Server èƒ½å¤Ÿå®‰å…¨ã€é«˜æ•ˆåœ°å¤„ç†å¤šä¸ªç”¨æˆ·åŒæ—¶è®¿é—®ï¼Œæˆ‘ä»¬å®ç°äº†ä»¥ä¸‹æœºåˆ¶ï¼š

- âœ… **å¤šçº¿ç¨‹å¤„ç†**ï¼šåŒæ—¶å¤„ç†å¤šä¸ª HTTP è¯·æ±‚
- âœ… **æ•°æ®åº“è¿æ¥æ± **ï¼šé«˜æ•ˆç®¡ç†æ•°æ®åº“è¿æ¥
- âœ… **ä¹è§‚é”**ï¼šé˜²æ­¢å¹¶å‘æ›´æ–°å†²çª
- âœ… **äº‹åŠ¡éš”ç¦»**ï¼šç¡®ä¿æ•°æ®ä¸€è‡´æ€§
- âœ… **è‡ªåŠ¨é‡è¯•**ï¼šå¤„ç†çŸ­æš‚çš„å¹¶å‘å†²çª

---

## å¤šçº¿ç¨‹è¿æ¥å¤„ç†

### 1. Tomcat çº¿ç¨‹æ± 

**é—®é¢˜**ï¼šå¦‚æœåªæœ‰ä¸€ä¸ªçº¿ç¨‹å¤„ç†è¯·æ±‚ï¼Œç”¨æˆ·å¿…é¡»æ’é˜Ÿç­‰å¾…ï¼Œä½“éªŒå¾ˆå·®ã€‚

**è§£å†³æ–¹æ¡ˆ**ï¼šé…ç½® Tomcat çº¿ç¨‹æ± ï¼Œè®©å¤šä¸ªçº¿ç¨‹åŒæ—¶å¤„ç†è¯·æ±‚ã€‚

```yaml
server:
  servlet:
    threads:
      max: 200        # æœ€å¤š 200 ä¸ªçº¿ç¨‹åŒæ—¶å·¥ä½œ
      min-spare: 10   # ä¿æŒ 10 ä¸ªçº¿ç¨‹éšæ—¶å¾…å‘½
```

**å·¥ä½œåŸç†**ï¼š
```
ç”¨æˆ·è¯·æ±‚ â†’ Tomcat æ¥æ”¶ â†’ åˆ†é…çº¿ç¨‹å¤„ç† â†’ è¿”å›å“åº”
         â†“
    å¦‚æœæ‰€æœ‰çº¿ç¨‹éƒ½åœ¨å¿™ï¼Œè¯·æ±‚è¿›å…¥é˜Ÿåˆ—ç­‰å¾…
```

**ç¤ºä¾‹åœºæ™¯**ï¼š
- ç”¨æˆ· A è¯·æ±‚ä»»åŠ¡åˆ—è¡¨ â†’ çº¿ç¨‹ 1 å¤„ç†
- ç”¨æˆ· B æ›´æ–°ä»»åŠ¡ â†’ çº¿ç¨‹ 2 å¤„ç†
- ç”¨æˆ· C åˆ›å»ºæ—¥è®° â†’ çº¿ç¨‹ 3 å¤„ç†
- ä¸‰ä¸ªè¯·æ±‚å¯ä»¥**åŒæ—¶**å¤„ç†ï¼Œä¸éœ€è¦æ’é˜Ÿï¼

### 2. æ•°æ®åº“è¿æ¥æ± ï¼ˆHikariCPï¼‰

**é—®é¢˜**ï¼šæ¯æ¬¡è®¿é—®æ•°æ®åº“éƒ½åˆ›å»ºæ–°è¿æ¥å¾ˆæ…¢ï¼Œè€Œä¸”æ•°æ®åº“è¿æ¥æ•°æœ‰é™ã€‚

**è§£å†³æ–¹æ¡ˆ**ï¼šä½¿ç”¨è¿æ¥æ± ï¼Œé¢„å…ˆåˆ›å»ºä¸€äº›è¿æ¥ï¼Œé‡å¤ä½¿ç”¨ã€‚

```yaml
spring:
  datasource:
    hikari:
      maximum-pool-size: 20    # æœ€å¤š 20 ä¸ªæ•°æ®åº“è¿æ¥
      minimum-idle: 5           # ä¿æŒ 5 ä¸ªç©ºé—²è¿æ¥
```

**å·¥ä½œåŸç†**ï¼š
```
åº”ç”¨å¯åŠ¨ â†’ åˆ›å»º 5 ä¸ªæ•°æ®åº“è¿æ¥ï¼ˆç©ºé—²çŠ¶æ€ï¼‰
         â†“
ç”¨æˆ·è¯·æ±‚ â†’ ä»æ± ä¸­å–ä¸€ä¸ªè¿æ¥ â†’ æ‰§è¡Œ SQL â†’ å½’è¿˜è¿æ¥åˆ°æ± ä¸­
         â†“
    å¦‚æœæ‰€æœ‰è¿æ¥éƒ½åœ¨ç”¨ï¼Œè¯·æ±‚ç­‰å¾…ç›´åˆ°æœ‰è¿æ¥å¯ç”¨
```

**ä¸ºä»€ä¹ˆéœ€è¦è¿æ¥æ± **ï¼š
- åˆ›å»ºæ•°æ®åº“è¿æ¥å¾ˆæ…¢ï¼ˆéœ€è¦ç½‘ç»œæ¡æ‰‹ã€è®¤è¯ç­‰ï¼‰
- æ•°æ®åº“æœåŠ¡å™¨èƒ½åŒæ—¶å¤„ç†çš„è¿æ¥æ•°æœ‰é™
- è¿æ¥æ± å¯ä»¥å¤ç”¨è¿æ¥ï¼Œå¤§å¤§æé«˜æ€§èƒ½

---

## å¹¶å‘æ§åˆ¶æœºåˆ¶

### 1. äº‹åŠ¡éš”ç¦»çº§åˆ«

**é—®é¢˜**ï¼šå¦‚æœä¸¤ä¸ªç”¨æˆ·åŒæ—¶è¯»å–å’Œä¿®æ”¹åŒä¸€æ¡æ•°æ®ï¼Œå¯èƒ½äº§ç”Ÿæ•°æ®ä¸ä¸€è‡´ã€‚

**è§£å†³æ–¹æ¡ˆ**ï¼šä½¿ç”¨ `READ_COMMITTED` éš”ç¦»çº§åˆ«ï¼Œç¡®ä¿è¯»å–çš„æ•°æ®æ˜¯å·²æäº¤çš„ã€‚

```java
@Transactional(isolation = Isolation.READ_COMMITTED)
public class TaskService {
    // æ‰€æœ‰æ–¹æ³•éƒ½åœ¨äº‹åŠ¡ä¸­æ‰§è¡Œ
}
```

**éš”ç¦»çº§åˆ«è¯´æ˜**ï¼š

| éš”ç¦»çº§åˆ« | é˜²æ­¢è„è¯» | é˜²æ­¢ä¸å¯é‡å¤è¯» | é˜²æ­¢å¹»è¯» | æ€§èƒ½ |
|---------|---------|--------------|---------|------|
| READ_UNCOMMITTED | âŒ | âŒ | âŒ | æœ€å¿« |
| **READ_COMMITTED** | âœ… | âŒ | âŒ | **å¿«** |
| REPEATABLE_READ | âœ… | âœ… | âŒ | ä¸­ç­‰ |
| SERIALIZABLE | âœ… | âœ… | âœ… | æœ€æ…¢ |

æˆ‘ä»¬é€‰æ‹© `READ_COMMITTED`ï¼Œå› ä¸ºå®ƒåœ¨æ€§èƒ½å’Œä¸€è‡´æ€§ä¹‹é—´å–å¾—äº†å¾ˆå¥½çš„å¹³è¡¡ã€‚

### 2. ä¹è§‚é”ï¼ˆOptimistic Lockingï¼‰

**é—®é¢˜**ï¼šä¸¤ä¸ªç”¨æˆ·åŒæ—¶ä¿®æ”¹åŒä¸€ä¸ªä»»åŠ¡ï¼Œåæäº¤çš„ä¼šè¦†ç›–å…ˆæäº¤çš„ï¼Œå¯¼è‡´æ•°æ®ä¸¢å¤±ã€‚

**è§£å†³æ–¹æ¡ˆ**ï¼šä½¿ç”¨ç‰ˆæœ¬å·ï¼ˆVersionï¼‰æœºåˆ¶ï¼Œæ£€æµ‹å¹¶å‘å†²çªã€‚

#### 2.1 å®ä½“ç±»æ·»åŠ ç‰ˆæœ¬å­—æ®µ

```java
@Entity
public class Task {
    @Id
    private Long id;
    
    @Version  // ğŸ‘ˆ å…³é”®ï¼šæ·»åŠ ç‰ˆæœ¬å­—æ®µ
    private Long version;
    
    private String title;
    // ... å…¶ä»–å­—æ®µ
}
```

#### 2.2 å·¥ä½œåŸç†

**åœºæ™¯**ï¼šç”¨æˆ· A å’Œç”¨æˆ· B åŒæ—¶ä¿®æ”¹ä»»åŠ¡ "å®ŒæˆæŠ¥å‘Š"

```
æ—¶é—´çº¿ï¼š
T1: ç”¨æˆ· A è¯»å–ä»»åŠ¡ (version = 1)
T2: ç”¨æˆ· B è¯»å–ä»»åŠ¡ (version = 1)
T3: ç”¨æˆ· A ä¿®æ”¹æ ‡é¢˜ä¸º "å®ŒæˆæŠ¥å‘Š v1" å¹¶ä¿å­˜
    â†’ JPA æ£€æŸ¥ï¼šæ•°æ®åº“ä¸­çš„ version è¿˜æ˜¯ 1ï¼Ÿæ˜¯ï¼
    â†’ æ›´æ–°æˆåŠŸï¼Œversion è‡ªåŠ¨å˜ä¸º 2
T4: ç”¨æˆ· B ä¿®æ”¹æ ‡é¢˜ä¸º "å®ŒæˆæŠ¥å‘Š v2" å¹¶ä¿å­˜
    â†’ JPA æ£€æŸ¥ï¼šæ•°æ®åº“ä¸­çš„ version è¿˜æ˜¯ 1ï¼Ÿä¸æ˜¯ï¼ç°åœ¨æ˜¯ 2
    â†’ æŠ›å‡º OptimisticLockingFailureException
    â†’ æ›´æ–°å¤±è´¥ï¼Œé˜²æ­¢è¦†ç›–ç”¨æˆ· A çš„ä¿®æ”¹
```

**ä»£ç å®ç°**ï¼š

```java
@Retryable(value = {OptimisticLockingFailureException.class}, 
           maxAttempts = 3, 
           backoff = @Backoff(delay = 100))
public Task updateTask(Long id, Long userId, Task updatedTask) {
    // 1. ä»æ•°æ®åº“è¯»å–ä»»åŠ¡ï¼ˆåŒ…å« versionï¼‰
    Task existingTask = taskRepository.findByIdAndUser_Id(id, userId)
        .orElseThrow(() -> new RuntimeException("ä»»åŠ¡ä¸å­˜åœ¨"));
    
    // 2. æ›´æ–°å­—æ®µ
    existingTask.setTitle(updatedTask.getTitle());
    // ... å…¶ä»–æ›´æ–°
    
    // 3. ä¿å­˜æ—¶ï¼ŒJPA ä¼šè‡ªåŠ¨æ£€æŸ¥ version
    //    UPDATE tasks SET title=?, version=version+1 
    //    WHERE id=? AND version=?  â† å¦‚æœ version ä¸åŒ¹é…ï¼Œæ›´æ–° 0 è¡Œ
    return taskRepository.save(existingTask);
}
```

**è‡ªåŠ¨é‡è¯•æœºåˆ¶**ï¼š

å¦‚æœå‘ç”Ÿå†²çªï¼Œ`@Retryable` ä¼šè‡ªåŠ¨é‡è¯•ï¼ˆæœ€å¤š 3 æ¬¡ï¼Œæ¯æ¬¡é—´éš” 100msï¼‰ï¼š

```
ç¬¬ 1 æ¬¡å°è¯•ï¼šå¤±è´¥ï¼ˆversion ä¸åŒ¹é…ï¼‰
    â†“ ç­‰å¾… 100ms
ç¬¬ 2 æ¬¡å°è¯•ï¼šé‡æ–°è¯»å–æœ€æ–°æ•°æ®ï¼Œå†æ¬¡å°è¯•æ›´æ–°
    â†“ å¦‚æœè¿˜æ˜¯å¤±è´¥ï¼Œç­‰å¾… 100ms
ç¬¬ 3 æ¬¡å°è¯•ï¼šæœ€åä¸€æ¬¡å°è¯•
    â†“ å¦‚æœè¿˜æ˜¯å¤±è´¥ï¼ŒæŠ›å‡ºå¼‚å¸¸ç»™ Controller
```

#### 2.3 Controller å±‚å¤„ç†

```java
@PutMapping("/{id}")
public ResponseEntity<Task> updateTask(...) {
    try {
        Task updated = taskService.updateTask(id, userId, task);
        return ResponseEntity.ok(updated);
    } catch (OptimisticLockingFailureException e) {
        // è¿”å› 409 Conflictï¼Œå‘Šè¯‰å‰ç«¯æ•°æ®å·²è¢«ä¿®æ”¹
        return ResponseEntity.status(HttpStatus.CONFLICT)
                .header("X-Error-Message", "ä»»åŠ¡å·²è¢«å…¶ä»–æ“ä½œä¿®æ”¹ï¼Œè¯·åˆ·æ–°åé‡è¯•")
                .build();
    }
}
```

**å‰ç«¯å¤„ç†**ï¼š
```javascript
// å‰ç«¯æ”¶åˆ° 409 å“åº”åï¼Œå¯ä»¥æç¤ºç”¨æˆ·åˆ·æ–°
if (response.status === 409) {
    alert('æ•°æ®å·²è¢«ä¿®æ”¹ï¼Œè¯·åˆ·æ–°é¡µé¢åé‡è¯•');
    // é‡æ–°åŠ è½½æ•°æ®
    loadTask();
}
```

---

## å·¥ä½œåŸç†è¯¦è§£

### å®Œæ•´è¯·æ±‚æµç¨‹

```
1. ç”¨æˆ· A å‘èµ·æ›´æ–°ä»»åŠ¡è¯·æ±‚
   â†“
2. Tomcat çº¿ç¨‹æ± åˆ†é…çº¿ç¨‹ 1 å¤„ç†è¯·æ±‚
   â†“
3. Controller éªŒè¯ç”¨æˆ·èº«ä»½ï¼Œæå– userId
   â†“
4. Service å±‚å¼€å§‹äº‹åŠ¡ï¼ˆREAD_COMMITTED éš”ç¦»çº§åˆ«ï¼‰
   â†“
5. ä» HikariCP è¿æ¥æ± è·å–æ•°æ®åº“è¿æ¥
   â†“
6. Repository æŸ¥è¯¢ä»»åŠ¡ï¼ˆåŒ…å« version å­—æ®µï¼‰
   â†“
7. Service æ›´æ–°ä»»åŠ¡å­—æ®µ
   â†“
8. Repository ä¿å­˜ä»»åŠ¡
   â†’ JPA æ‰§è¡Œï¼šUPDATE tasks SET ... WHERE id=? AND version=?
   â†’ å¦‚æœ version åŒ¹é…ï¼šæ›´æ–°æˆåŠŸï¼Œversion++
   â†’ å¦‚æœ version ä¸åŒ¹é…ï¼šæ›´æ–° 0 è¡Œï¼ŒæŠ›å‡º OptimisticLockingFailureException
   â†“
9. å¦‚æœå‘ç”Ÿå†²çªï¼Œ@Retryable è‡ªåŠ¨é‡è¯•ï¼ˆæœ€å¤š 3 æ¬¡ï¼‰
   â†“
10. äº‹åŠ¡æäº¤ï¼Œå½’è¿˜æ•°æ®åº“è¿æ¥åˆ°è¿æ¥æ± 
   â†“
11. Controller è¿”å›å“åº”ç»™ç”¨æˆ·
   â†“
12. çº¿ç¨‹ 1 é‡Šæ”¾ï¼Œå¯ä»¥å¤„ç†ä¸‹ä¸€ä¸ªè¯·æ±‚
```

### å¹¶å‘åœºæ™¯ç¤ºä¾‹

**åœºæ™¯**ï¼š100 ä¸ªç”¨æˆ·åŒæ—¶æ›´æ–°ä¸åŒçš„ä»»åŠ¡

```
æ—¶é—´çº¿ï¼š
T0: 100 ä¸ªè¯·æ±‚åŒæ—¶åˆ°è¾¾
T1: Tomcat åˆ†é… 100 ä¸ªçº¿ç¨‹ï¼ˆå‡è®¾æœ‰è¶³å¤Ÿçº¿ç¨‹ï¼‰
T2: æ¯ä¸ªçº¿ç¨‹ä»è¿æ¥æ± è·å–æ•°æ®åº“è¿æ¥ï¼ˆæœ€å¤š 20 ä¸ªè¿æ¥ï¼‰
    â†’ å‰ 20 ä¸ªè¯·æ±‚ç«‹å³è·å–è¿æ¥
    â†’ å 80 ä¸ªè¯·æ±‚åœ¨è¿æ¥æ± é˜Ÿåˆ—ä¸­ç­‰å¾…
T3: å‰ 20 ä¸ªè¯·æ±‚æ‰§è¡Œå®Œæˆï¼Œå½’è¿˜è¿æ¥
T4: å 80 ä¸ªè¯·æ±‚ä¾æ¬¡è·å–è¿æ¥å¹¶æ‰§è¡Œ
T5: æ‰€æœ‰è¯·æ±‚å®Œæˆ

ç»“æœï¼šæ‰€æœ‰è¯·æ±‚éƒ½æˆåŠŸå¤„ç†ï¼Œæ²¡æœ‰æ•°æ®å†²çªï¼ˆå› ä¸ºæ›´æ–°çš„æ˜¯ä¸åŒçš„ä»»åŠ¡ï¼‰
```

**åœºæ™¯**ï¼š2 ä¸ªç”¨æˆ·åŒæ—¶æ›´æ–°åŒä¸€ä¸ªä»»åŠ¡

```
æ—¶é—´çº¿ï¼š
T1: ç”¨æˆ· A è¯»å–ä»»åŠ¡ (version=1)
T2: ç”¨æˆ· B è¯»å–ä»»åŠ¡ (version=1)
T3: ç”¨æˆ· A ä¿å­˜ â†’ æˆåŠŸ (version å˜ä¸º 2)
T4: ç”¨æˆ· B ä¿å­˜ â†’ å¤±è´¥ï¼(version ä¸åŒ¹é…)
    â†’ æŠ›å‡º OptimisticLockingFailureException
    â†’ @Retryable è‡ªåŠ¨é‡è¯•
    â†’ é‡æ–°è¯»å–ä»»åŠ¡ (version=2)
    â†’ ä½¿ç”¨æœ€æ–°æ•°æ®å†æ¬¡æ›´æ–°
    â†’ æˆåŠŸ (version å˜ä¸º 3)

ç»“æœï¼šç”¨æˆ· B çš„æ›´æ–°åŸºäºæœ€æ–°æ•°æ®ï¼Œä¸ä¼šè¦†ç›–ç”¨æˆ· A çš„ä¿®æ”¹
```

---

## å®é™…åº”ç”¨åœºæ™¯

### åœºæ™¯ 1ï¼šå¤šç”¨æˆ·åŒæ—¶ä½¿ç”¨

**é—®é¢˜**ï¼š10 ä¸ªç”¨æˆ·åŒæ—¶ä½¿ç”¨ç³»ç»Ÿï¼Œæ¯ä¸ªäººéƒ½åœ¨åˆ›å»ºã€æ›´æ–°ä»»åŠ¡ã€‚

**è§£å†³æ–¹æ¡ˆ**ï¼š
- Tomcat çº¿ç¨‹æ± å¤„ç†å¤šä¸ªè¯·æ±‚
- æ¯ä¸ªç”¨æˆ·çš„æ•°æ®é€šè¿‡ `userId` éš”ç¦»
- ä¹è§‚é”é˜²æ­¢åŒä¸€ç”¨æˆ·åœ¨ä¸åŒè®¾å¤‡ä¸ŠåŒæ—¶ä¿®æ”¹åŒä¸€ä»»åŠ¡

### åœºæ™¯ 2ï¼šç§»åŠ¨ç«¯å’Œ Web ç«¯åŒæ—¶æ“ä½œ

**é—®é¢˜**ï¼šç”¨æˆ·åœ¨æ‰‹æœºä¸Šæ›´æ–°ä»»åŠ¡ï¼ŒåŒæ—¶åœ¨ç”µè„‘ä¸Šä¹Ÿåœ¨æ›´æ–°åŒä¸€ä¸ªä»»åŠ¡ã€‚

**è§£å†³æ–¹æ¡ˆ**ï¼š
- ä¹è§‚é”æ£€æµ‹åˆ°å†²çª
- è‡ªåŠ¨é‡è¯•æœºåˆ¶å°è¯•åˆå¹¶æ›´æ–°
- å¦‚æœé‡è¯•å¤±è´¥ï¼Œè¿”å› 409 é”™è¯¯ï¼Œæç¤ºç”¨æˆ·åˆ·æ–°

### åœºæ™¯ 3ï¼šé«˜å¹¶å‘è®¿é—®

**é—®é¢˜**ï¼šç³»ç»Ÿçªç„¶æœ‰å¤§é‡ç”¨æˆ·è®¿é—®ï¼ˆæ¯”å¦‚ä¿ƒé”€æ´»åŠ¨ï¼‰ã€‚

**è§£å†³æ–¹æ¡ˆ**ï¼š
- çº¿ç¨‹æ± å¯ä»¥å¤„ç†å¤§é‡å¹¶å‘è¯·æ±‚
- è¿æ¥æ± å¤ç”¨æ•°æ®åº“è¿æ¥ï¼Œæé«˜æ•ˆç‡
- å¦‚æœè¿æ¥æ± è€—å°½ï¼Œè¯·æ±‚ä¼šåœ¨é˜Ÿåˆ—ä¸­ç­‰å¾…ï¼Œä¸ä¼šå´©æºƒ

---

## ä»£ç ç¤ºä¾‹

### ç¤ºä¾‹ 1ï¼šæ›´æ–°ä»»åŠ¡ï¼ˆå®Œæ•´æµç¨‹ï¼‰

```java
// Controller å±‚
@PutMapping("/{id}")
public ResponseEntity<Task> updateTask(
        HttpServletRequest request,
        @PathVariable Long id,
        @RequestBody Task task) {
    
    // 1. éªŒè¯ç”¨æˆ·èº«ä»½
    Long userId = (Long) request.getAttribute("userId");
    if (userId == null) {
        return ResponseEntity.status(HttpStatus.UNAUTHORIZED).build();
    }
    
    try {
        // 2. è°ƒç”¨ Service æ›´æ–°ï¼ˆåŒ…å«ä¹è§‚é”å’Œé‡è¯•æœºåˆ¶ï¼‰
        Task updated = taskService.updateTask(id, userId, task);
        return ResponseEntity.ok(updated);
    } catch (OptimisticLockingFailureException e) {
        // 3. å¤„ç†å¹¶å‘å†²çª
        return ResponseEntity.status(HttpStatus.CONFLICT)
                .header("X-Error-Message", "ä»»åŠ¡å·²è¢«å…¶ä»–æ“ä½œä¿®æ”¹ï¼Œè¯·åˆ·æ–°åé‡è¯•")
                .build();
    }
}

// Service å±‚
@Retryable(value = {OptimisticLockingFailureException.class}, 
           maxAttempts = 3, 
           backoff = @Backoff(delay = 100))
@Transactional(isolation = Isolation.READ_COMMITTED)
public Task updateTask(Long id, Long userId, Task updatedTask) {
    // 1. è¯»å–ä»»åŠ¡ï¼ˆåŒ…å« versionï¼‰
    Task existingTask = taskRepository.findByIdAndUser_Id(id, userId)
        .orElseThrow(() -> new RuntimeException("ä»»åŠ¡ä¸å­˜åœ¨"));
    
    // 2. æ›´æ–°å­—æ®µ
    if (updatedTask.getTitle() != null) {
        existingTask.setTitle(updatedTask.getTitle());
    }
    // ... å…¶ä»–æ›´æ–°
    
    // 3. ä¿å­˜ï¼ˆJPA è‡ªåŠ¨æ£€æŸ¥ versionï¼‰
    return taskRepository.save(existingTask);
    //    â†‘ å¦‚æœ version ä¸åŒ¹é…ï¼Œè¿™é‡Œä¼šæŠ›å‡º OptimisticLockingFailureException
    //    @Retryable ä¼šè‡ªåŠ¨é‡è¯•
}
```

### ç¤ºä¾‹ 2ï¼šå®ä½“ç±»ç‰ˆæœ¬å­—æ®µ

```java
@Entity
@Table(name = "tasks")
public class Task {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
    
    @Version  // ğŸ‘ˆ ä¹è§‚é”ç‰ˆæœ¬å·
    @Column(nullable = false)
    private Long version;
    
    private String title;
    // ... å…¶ä»–å­—æ®µ
    
    // Getter/Setter
    public Long getVersion() {
        return version;
    }
    
    public void setVersion(Long version) {
        this.version = version;
    }
}
```

### ç¤ºä¾‹ 3ï¼šå¼‚æ­¥ä»»åŠ¡å¤„ç†

```java
// é…ç½®ç±»
@Configuration
@EnableAsync
public class AsyncConfig {
    @Bean(name = "taskExecutor")
    public Executor taskExecutor() {
        ThreadPoolTaskExecutor executor = new ThreadPoolTaskExecutor();
        executor.setCorePoolSize(5);      // æ ¸å¿ƒçº¿ç¨‹æ•°
        executor.setMaxPoolSize(20);     // æœ€å¤§çº¿ç¨‹æ•°
        executor.setQueueCapacity(100);  // é˜Ÿåˆ—å®¹é‡
        executor.initialize();
        return executor;
    }
}

// Service å±‚ä½¿ç”¨
@Service
public class TaskService {
    @Async("taskExecutor")  // ğŸ‘ˆ å¼‚æ­¥æ‰§è¡Œ
    public void logTaskOperation(Long taskId, String operation) {
        // è¿™ä¸ªæ“ä½œä¼šåœ¨åå°çº¿ç¨‹ä¸­æ‰§è¡Œï¼Œä¸ä¼šé˜»å¡ä¸»è¯·æ±‚
        System.out.println("Task " + taskId + " operation: " + operation);
    }
}
```

---

## æ€»ç»“

é€šè¿‡ä»¥ä¸Šæœºåˆ¶ï¼ŒAsteriTime Server ç°åœ¨å¯ä»¥ï¼š

1. **åŒæ—¶å¤„ç†å¤šä¸ªè¯·æ±‚**ï¼šTomcat çº¿ç¨‹æ±  + HikariCP è¿æ¥æ± 
2. **é˜²æ­¢æ•°æ®å†²çª**ï¼šä¹è§‚é” + ç‰ˆæœ¬å·æœºåˆ¶
3. **è‡ªåŠ¨å¤„ç†å†²çª**ï¼š@Retryable è‡ªåŠ¨é‡è¯•
4. **ç¡®ä¿æ•°æ®ä¸€è‡´æ€§**ï¼šäº‹åŠ¡éš”ç¦»çº§åˆ«
5. **æé«˜æ€§èƒ½**ï¼šè¿æ¥æ± å¤ç”¨ + å¼‚æ­¥å¤„ç†

è¿™äº›æœºåˆ¶ç¡®ä¿äº†ç³»ç»Ÿåœ¨é«˜å¹¶å‘åœºæ™¯ä¸‹çš„**ç¨³å®šæ€§**ã€**å®‰å…¨æ€§**å’Œ**æ€§èƒ½**ã€‚

---

## ç›¸å…³æ–‡æ¡£

- [è¯¦ç»†é…ç½®æ–‡æ¡£](./CONCURRENCY.md) - åŒ…å«æ‰€æœ‰é…ç½®å‚æ•°å’Œæ•…éšœæ’æŸ¥
- [æ¶æ„æ–‡æ¡£](./ARCHITECTURE.md) - ç³»ç»Ÿæ•´ä½“æ¶æ„è¯´æ˜
- [æ•°æ®åº“æ–‡æ¡£](./DATABASE.md) - æ•°æ®åº“è®¾è®¡è¯´æ˜
